package com.aurionpro.bankapp.service.impl;

import com.aurionpro.bankapp.entity.CustomerAccount;
import com.aurionpro.bankapp.entity.Transaction;
import com.aurionpro.bankapp.entity.TypeOfTransaction;
import com.aurionpro.bankapp.repository.AccountRepository;
import com.aurionpro.bankapp.repository.CustomerAccountRepository;
import com.aurionpro.bankapp.repository.TransactionRepository;
import com.aurionpro.bankapp.service.TransactionService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Date;

@Service
public class TransactionServiceImpl implements TransactionService {

    @Autowired
    private CustomerAccountRepository customerAccountRepository;

    @Autowired
    private TransactionRepository transactionRepository;

    @Override
    public void deposit(long customerAccountNum, double amount) {
        CustomerAccount account = getAccount(customerAccountNum);
        account.setCustomerBalance(account.getCustomerBalance() + amount);
        customerAccountRepository.save(account);

        createTransaction(account, customerAccountNum, customerAccountNum, amount, TypeOfTransaction.CREDIT);
    }

    @Override
    public void withdraw(long customerAccountNum, double amount) {
        CustomerAccount account = getAccount(customerAccountNum);
        if (account.getCustomerBalance() - amount >= 1000) {
            account.setCustomerBalance(account.getCustomerBalance() - amount);
            customerAccountRepository.save(account);

            createTransaction(account, customerAccountNum, customerAccountNum, amount, TypeOfTransaction.DEBIT);
        } else {
            throw new IllegalArgumentException("Insufficient balance");
        }
    }

    @Override
    public void transfer(long fromAccountNum, long toAccountNum, double amount) {
        withdraw(fromAccountNum, amount);
        deposit(toAccountNum, amount);
    }

    private CustomerAccount getAccount(long accountNumber) {
        return customerAccountRepository.findByAccountNumber(accountNumber)
                .orElseThrow(() -> new IllegalArgumentException("Account not found"));
    }

    private void createTransaction(CustomerAccount account, long senderAccount, long receiverAccount, double amount, TypeOfTransaction typeOfTransaction) {
        Transaction transaction = new Transaction();
        transaction.setAccount(account);
        transaction.setSenderAccount(senderAccount);
        transaction.setReceiverAccount(receiverAccount);
        transaction.setAmount(amount);
        transaction.setTypeOfTransaction(typeOfTransaction);
        transaction.setDate(new Date());
        transactionRepository.save(transaction);
    }
}
